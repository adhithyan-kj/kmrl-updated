<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metro Mithra</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">


  <style>
    /* Custom scrollbar for message list */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #93c5fd;
      border-radius: 3px;
    }

    /* Style for the truncate-3-lines class */
    .truncate-3-lines {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Animation for view transitions */
    .main-view {
      transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }

    .view-fade-in {
      opacity: 1;
      transform: translateY(0);
    }

    .view-fade-out {
      opacity: 0;
      transform: translateY(10px);
    }

    .font-title {
      font-family: 'Cinzel', serif;
    }

    body {
      font-family: 'Inter', sans-serif;
    }

    /* NEW STYLES FOR DARK LOGIN */
    #login-screen {
        background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('img.jpg');
        background-size: cover;
        background-position: center;
    }

    .dark-input-bg {
      background-color: rgba(17, 24, 39, 0.4);
      /* bg-gray-900/40 */
      border-color: rgba(255, 255, 255, 0.2);
    }

    .dark-input-bg option {
      background: #111827;
      /* gray-900 */
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Login Screen -->
  <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen px-6">
    <h1 class="text-3xl font-bold text-gray-100 mb-8 font-title">Metro Mithra</h1>
    <div class="bg-gray-800/30 backdrop-blur-xl border border-gray-400/20 shadow-2xl rounded-2xl px-8 pt-6 pb-8 w-full max-w-sm">

      <!-- Login Step 1: Role and Location Selection -->
      <div id="login-step-1">
        <div class="mb-4">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="role-type">Select Role Type</label>
          <select id="role-type" class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500">
            <option value="">Select your role type</option>
            <option value="Central Command">Central Command</option>
            <option value="Field Units">Field Units</option>
          </select>
        </div>

        <div id="central-command-roles" class="mb-4 hidden">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="central-command-role">Role in Central
            Command</label>
          <select id="central-command-role" class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500">
            <option value="">Select your role</option>
            <option value="Managing Director">Managing Director</option>
            <option value="Director of Finance">Director of Finance</option>
            <option value="Director of Operations">Director of Operations</option>
          </select>
        </div>

        <div id="field-units-roles" class="mb-4 hidden">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="field-unit-role">Role in Field Units</label>
          <select id="field-unit-role" class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500">
            <option value="">Select your role</option>
            <option value="Station Controller">Station Controller</option>
            <option value="Depot Manager">Depot Manager</option>
          </select>
        </div>

        <div id="field-units-location" class="mb-4 hidden">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="field-unit-location">Field Location</label>
          <select id="field-unit-location" class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500">
            <option value="">Select your location</option>
          </select>
        </div>

        <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline w-full transition ease-in-out duration-150">
          Next
        </button>
      </div>

      <!-- Login Step 2: Username and Password -->
      <div id="login-step-2" class="hidden">
        <div class="mb-4">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="employee-name">Employee Name</label>
          <input id="employee-name" type="text" placeholder="Your Name" required class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500" />
        </div>
        <div class="mb-4">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="username">Username</label>
          <input id="username" type="text" placeholder="username123" required class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500" />
        </div>
        <div class="mb-6">
          <label class="block text-gray-300 text-sm font-bold mb-2" for="password">Password</label>
          <input id="password" type="password" placeholder="****" required class="dark-input-bg appearance-none border rounded-xl w-full py-2 px-3 text-gray-100 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-500" />
        </div>
        <button id="proceed-to-login-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline w-full transition ease-in-out duration-150">
          Sign In
        </button>
      </div>

    </div>
  </div>

  <!-- Main Dashboard Screen -->
  <div id="dashboard-screen" class="hidden flex-1 flex">
    <!-- Side Menu -->
    <nav id="side-menu" class="w-72 bg-blue-800 text-white flex flex-col p-4">
      <div class="flex items-center mb-10">
        <div class="bg-white rounded-full w-10 h-10 flex items-center justify-center mr-3">
          <span class="text-blue-800 font-bold text-lg">MM</span>
        </div>
        <h1 class="text-xl font-bold">Metro Mithra</h1>
      </div>

      <p class="px-3 text-xs uppercase text-blue-300 font-semibold mb-2">Main</p>
      <ul class="flex flex-col space-y-2 mb-6">
        <li><a href="#" data-view="dashboard-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="layout-dashboard" class="mr-3"></i>Dashboard</a></li>
        <li><a href="#" data-view="messages-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="mail" class="mr-3"></i>Messages</a></li>
        <li><a href="#" data-view="analytics-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="bar-chart-2" class="mr-3"></i>Analytics</a></li>
      </ul>

      <p class="px-3 text-xs uppercase text-blue-300 font-semibold mb-2">Problem Solvers</p>
      <ul class="flex flex-col space-y-2">
        <li><a href="#" data-view="passenger-flow-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="users" class="mr-3"></i>Passenger Flow</a></li>
        <li><a href="#" data-view="maintenance-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="wrench" class="mr-3"></i>Predictive Maintenance</a></li>
        <li><a href="#" data-view="energy-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="bolt" class="mr-3"></i>Energy Usage</a></li>
        <li><a href="#" data-view="revenue-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="dollar-sign" class="mr-3"></i>Non-Fare Revenue</a></li>
        <li><a href="#" data-view="incident-view" class="side-menu-link flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"><i data-lucide="siren" class="mr-3"></i>Incident Response</a></li>
      </ul>

      <div class="mt-auto">
        <button id="sign-out-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
          <i data-lucide="log-out" class="mr-2"></i>Logout
        </button>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Dashboard View -->
      <div id="dashboard-view" class="main-view">
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
          <h2 id="welcome-message" class="text-2xl font-bold text-gray-800">Welcome!</h2>
          <p id="role-subtitle" class="text-gray-600">Your personalized dashboard.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-500 mb-4">Key Metrics</h3>
            <div class="space-y-4">
              <div class="flex justify-between items-baseline">
                <span class="text-gray-600">Total Documents</span>
                <span id="metric-total-docs" class="font-bold text-3xl text-blue-600">0</span>
              </div>
              <div class="flex justify-between items-baseline">
                <span class="text-gray-600">Unread Messages</span>
                <span id="metric-unread" class="font-bold text-3xl text-yellow-500">0</span>
              </div>
              <div class="flex justify-between items-baseline">
                <span class="text-gray-600">Pending Tasks</span>
                <span id="metric-pending" class="font-bold text-3xl text-red-500">0</span>
              </div>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md md:col-span-2">
            <h3 class="text-lg font-semibold text-gray-500 mb-4">Recent Activity</h3>
            <ul id="recent-activity-list" class="space-y-3">
              <li class="text-gray-500">No recent activity.</li>
            </ul>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md">
          <h3 class="text-lg font-semibold text-gray-500 mb-4">Pending Tasks</h3>
          <ul id="pending-tasks-list" class="space-y-3">
            <li class="text-gray-500">No pending tasks.</li>
          </ul>
        </div>
      </div>

      <!-- Messages View -->
      <div id="messages-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Messages & Documents</h2>
        <div class="bg-white p-4 rounded-xl shadow mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex-1">
              <input type="text" id="search-input" placeholder="Search messages..."
                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" />
            </div>
            <div class="flex items-center space-x-4">
              <select id="tag-filter" class="px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                <option value="All">All Tags</option>
              </select>
              <select id="priority-filter" class="px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                <option value="All">All Priorities</option>
              </select>
            </div>
          </div>
        </div>
        <div id="messages-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>

      <!-- Analytics View -->
      <div id="analytics-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Deep Dive Analytics</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Message Activity</h3>
            <div class="h-64"><canvas id="activity-chart"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Messages by Priority</h3>
            <div class="h-64"><canvas id="priority-chart"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Message Type Distribution</h3>
            <div class="h-64"><canvas id="type-chart"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Read vs. Unread by Priority</h3>
            <div class="h-64"><canvas id="read-unread-chart"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Departmental Workload</h3>
            <div class="h-64"><canvas id="workload-chart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Problem Solver Views -->
      <div id="passenger-flow-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Passenger Flow Optimization</h2>
        <p class="text-gray-600 mb-6">Analyze peak hours to adjust train frequency, reducing congestion and improving passenger experience.</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Hourly Passenger Traffic (Weekday)</h3>
            <canvas id="passenger-flow-chart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Station Entry vs. Exit Counts</h3>
            <canvas id="station-traffic-chart"></canvas>
          </div>
        </div>
      </div>
      <div id="maintenance-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Predictive Maintenance</h2>
        <p class="text-gray-600 mb-6">Monitor equipment health to predict failures and schedule maintenance proactively.</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Brake System Health Score - Unit #102</h3>
            <canvas id="maintenance-chart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Component Failure Rate</h3>
            <canvas id="component-failure-chart"></canvas>
          </div>
        </div>
      </div>
      <div id="energy-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Energy Usage Monitoring</h2>
        <p class="text-gray-600 mb-6">Track daily energy consumption against targets to identify anomalies and promote energy-saving practices.</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Energy Consumption (MWh)</h3>
            <canvas id="energy-chart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Consumption by Sub-system</h3>
            <canvas id="energy-breakdown-chart"></canvas>
          </div>
        </div>
      </div>
      <div id="revenue-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Non-Fare Revenue Enhancement</h2>
        <p class="text-gray-600 mb-6">Analyze revenue streams from sources other than tickets to identify opportunities for growth.</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Non-Fare Revenue Sources - Q2 2025</h3>
            <canvas id="revenue-chart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Revenue Growth</h3>
            <canvas id="revenue-growth-chart"></canvas>
          </div>
        </div>
      </div>
      <div id="incident-view" class="main-view hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Incident Response Time Analysis</h2>
        <p class="text-gray-600 mb-6">Measure and compare response times for different incident types to improve safety protocols and team efficiency.</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Average Response Time by Type (Mins)</h3>
            <canvas id="incident-chart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-md h-96">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Incidents by Time of Day</h3>
            <canvas id="incident-time-chart"></canvas>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Modal for full message view -->
  <div id="full-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h3 id="modal-title" class="text-lg font-bold">Message Details</h3>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto flex-1 scrollbar-thin">
        <p id="modal-content" class="text-gray-700 mb-4"></p>
        <div class="flex items-center justify-start space-x-2 mb-4">
          <span class="text-xs font-semibold uppercase text-blue-600 rounded-full px-2 py-1 bg-blue-100" id="modal-tag"></span>
          <span class="text-xs font-semibold uppercase rounded-full px-2 py-1 text-white" id="modal-priority-tag"></span>
        </div>

        <div class="mt-4 p-4 bg-gray-100 rounded-xl">
          <h4 class="text-md font-bold text-gray-800 mb-2">AI Summarizer</h4>
          <div class="flex items-center space-x-2 mb-4">
             <button id="summarize-email-btn"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl text-sm">
              Summarize Email
            </button>
          </div>
          <div id="summary-section">
            <p id="summary-el" class="text-gray-600 text-sm whitespace-pre-line"></p>
          </div>
        </div>
      </div>
      <div class="p-4 bg-gray-50 border-t">
        <button id="forward-message-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-xl w-full sm:w-auto">
          Forward Message
        </button>
      </div>
    </div>
  </div>

  <div id="forward-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-bold">Forward Message</h3>
        <button id="close-forward-modal-btn" class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
      </div>
      <div class="p-6">
        <p class="mb-4">Select a role to forward this message to:</p>
        <select id="forward-role-select" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
      </div>
      <div class="p-4 bg-gray-50 border-t text-right">
        <button id="send-forward-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl">Send Forward</button>
      </div>
    </div>
  </div>

  <div id="message-box" class="fixed top-4 right-4 z-50 p-4 bg-white rounded-xl shadow-lg hidden">
    <div class="flex justify-between items-center mb-2">
      <h4 id="message-box-title" class="font-bold text-lg text-gray-800"></h4>
      <button id="close-message-box" class="text-gray-500 hover:text-gray-800">&times;</button>
    </div>
    <p id="message-box-content" class="text-sm text-gray-600"></p>
  </div>


  <script>
    const loginScreen = document.getElementById("login-screen");
    const dashboardScreen = document.getElementById("dashboard-screen");
    const signOutBtn = document.getElementById("sign-out-btn");
    const messagesContainer = document.getElementById("messages-container");
    const searchInput = document.getElementById("search-input");
    const tagFilter = document.getElementById("tag-filter");
    const priorityFilter = document.getElementById("priority-filter");

    const loginStep1 = document.getElementById("login-step-1");
    const loginStep2 = document.getElementById("login-step-2");
    const roleTypeSelect = document.getElementById("role-type");
    const centralCommandRolesDiv = document.getElementById("central-command-roles");
    const centralCommandRoleSelect = document.getElementById("central-command-role");
    const fieldUnitsRolesDiv = document.getElementById("field-units-roles");
    const fieldUnitRoleSelect = document.getElementById("field-unit-role");
    const fieldUnitsLocationDiv = document.getElementById("field-units-location");
    const fieldUnitLocationSelect = document.getElementById("field-unit-location");
    const nextBtn = document.getElementById("next-btn");
    const proceedToLoginBtn = document.getElementById("proceed-to-login-btn");
    const employeeNameInput = document.getElementById("employee-name");
    const usernameInput = document.getElementById("username");

    const fullMessageModal = document.getElementById("full-message-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalContent = document.getElementById("modal-content");
    const modalTag = document.getElementById("modal-tag");
    const modalPriorityTag = document.getElementById("modal-priority-tag");
    const closeModalBtn = document.getElementById("close-modal-btn");

    const summarizeEmailBtn = document.getElementById("summarize-email-btn");
    const summaryEl = document.getElementById("summary-el");

    const messageBox = document.getElementById("message-box");
    const messageBoxTitle = document.getElementById("message-box-title");
    const messageBoxContent = document.getElementById("message-box-content");
    const closeMessageBoxBtn = document.getElementById("close-message-box");

    const sideMenuLinks = document.querySelectorAll(".side-menu-link");
    const mainViews = document.querySelectorAll(".main-view");
    const welcomeMessage = document.getElementById("welcome-message");
    const roleSubtitle = document.getElementById("role-subtitle");
    const metricTotalDocs = document.getElementById('metric-total-docs');
    const metricUnread = document.getElementById('metric-unread');
    const metricPending = document.getElementById('metric-pending');
    const recentActivityList = document.getElementById('recent-activity-list');
    const pendingTasksList = document.getElementById('pending-tasks-list');
    const forwardMessageBtn = document.getElementById('forward-message-btn');
    const forwardMessageModal = document.getElementById('forward-message-modal');
    const closeForwardModalBtn = document.getElementById('close-forward-modal-btn');
    const forwardRoleSelect = document.getElementById('forward-role-select');
    const sendForwardBtn = document.getElementById('send-forward-btn');

    let currentUser = null;
    let currentMessages = [];
    let messageToForward = null;
    let initializedCharts = {};
    let emailRefreshInterval = null; // To hold the timer
    const GEMINI_API_KEY = "AIzaSyBaSJz-8Ma99Whgh7OcqBAuWx9AlysEsoU";

    const stationLocations = ["Aluva", "Kalamassery", "Maharajas College", "Vyttila", "Petta"];
    const depotLocations = ["Muttom", "Thripunithura", "Kakkanad", "Petta", "Aluva Yard"];

    const roleSpecificTags = {
      'Station Controller': ["All", "Passenger complain", "shift rosters", "safety updates", "incident alerts", "revenue data"],
      'Depot Manager': ["All", "Rolling Stock", "Job Cards", "Spare parts", "Contractor reports", "depot safety"],
      'Managing Director': ["All", "finance", "operations", "projects", "HR", "safety", "regulations"],
      'Director of Finance': ["All", "budgets", "invoices", "purchase orders", "vendor contracts"],
      'Director of Operations': ["All", "maintenance", "safety circulars", "schedules", "incident reports"],
      'default': ["All", "general", "update", "report"]
    };

    const recentActivities = {
      'Managing Director': [
        { text: "Reviewed 'Q2 Finance Report'", status: 'completed' },
        { text: "Uploaded 'Safety Audit Report 2024'", status: 'completed' },
        { text: "New message from Finance: 'Budget for Maintenance'", status: 'new' },
        { text: "Pending approval for 'Vendor Invoice #456'", status: 'pending' },
      ],
      'default': [
        { text: "Daily report generated successfully", status: 'completed' },
        { text: "System health check passed", status: 'completed' },
        { text: "New message: 'Weekly Safety Bulletin'", status: 'new' },
        { text: "Pending review of shift rosters", status: 'pending' },
      ]
    };

    const pendingTasks = {
      'Managing Director': ["Approve Phase II expansion budget", "Review legal department's policy change proposal", "Prepare for 5-Year Strategic Plan meeting"],
      'Director of Finance': ["Finalize all departmental budgets by Friday EOD", "Approve Invoice #INV-987 for 'Tech Solutions'", "Respond to internal audit query on Q2 T&E"],
      'Director of Operations': ["Investigate root cause for 2% drop in OTP", "Review and advise on high overtime hours report", "Coordinate with technical team on signal failure incident"],
      'Station Controller': ["Investigate passenger complaint re: 10:30 AM train delay", "Dispatch technician for escalator fault on Platform 2", "Ensure staff have reviewed new shift rosters"],
      'Depot Manager': ["Assign team for Rolling Stock 102 monthly inspection", "Review and verify track cleaning contractor's report", "Schedule team meeting to discuss depot safety audit results"],
      'default': ["Complete mandatory annual training", "Update personal contact information in HR portal"]
    };

    // --- DATA FETCHING & TAGGING ---
    function assignTag(subject) {
      if (!subject) return 'general';
      const s = subject.toLowerCase();
      // Station Controller
      if (s.includes('complaint')) return 'Passenger complain';
      if (s.includes('roster')) return 'shift rosters';
      if (s.includes('safety') && !s.includes('circular')) return 'safety updates';
      if (s.includes('alert')) return 'incident alerts';
      if (s.includes('revenue')) return 'revenue data';
      // Depot Manager
      if (s.includes('rolling stock') || s.includes('rs 102')) return 'Rolling Stock';
      if (s.includes('job card')) return 'Job Cards';
      if (s.includes('spare part') || s.includes('inventory')) return 'Spare parts';
      if (s.includes('contractor')) return 'Contractor reports';
      if (s.includes('depot safety')) return 'depot safety';
      // Managing Director
      if (s.includes('finance') || s.includes('financial')) return 'finance';
      if (s.includes('operation')) return 'operations';
      if (s.includes('project')) return 'projects';
      if (s.includes('hr') || s.includes('employee survey')) return 'HR';
      if (s.includes('regulation') || s.includes('policy')) return 'regulations';
      // Director of Finance
      if (s.includes('budget')) return 'budgets';
      if (s.includes('invoice')) return 'invoices';
      if (s.includes('purchase order') || s.includes('po request')) return 'purchase orders';
      if (s.includes('vendor') || s.includes('contract')) return 'vendor contracts';
      // Director of Operations
      if (s.includes('maintenance')) return 'maintenance';
      if (s.includes('circular')) return 'safety circulars';
      if (s.includes('schedule')) return 'schedules';
      if (s.includes('incident')) return 'incident reports'; // Generic incident for Dir Ops

      return 'general'; // Default tag
    }

    async function fetchEmailsFromAPI(role) {
      console.log(`Fetching emails for role: ${role} from local server...`);
      try {
        const response = await fetch('/api/emails');
        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`HTTP error! Status: ${response.status}, Body: ${errorBody}`);
        }
        const emails = await response.json();
        return emails.map((email, index) => {
          let priority = "Low";
          if (email.subject && (email.subject.toLowerCase().includes('urgent') || email.subject.toLowerCase().includes('alert'))) {
            priority = "High";
          } else if (email.subject && (email.subject.toLowerCase().includes('report') || email.subject.toLowerCase().includes('update'))) {
            priority = "Medium";
          }
          return {
            id: index + 1,
            subject: email.subject || "No Subject",
            content: email.body || "No Content",
            sender: email.from || "Unknown Sender",
            isRead: false,
            type: 'Email',
            priority: priority,
            tag: assignTag(email.subject)
          };
        });
      } catch (error) {
        console.error("Could not fetch emails:", error);
        showMessageBox("Connection Error", `Could not connect to the email server. Error: ${error.message}.`);
        return [];
      }
    }

    // --- REAL-TIME REFRESH ---
    async function refreshMessages() {
      if (!currentUser) return; // Don't refresh if no user is logged in
      console.log("Checking for new emails...");

      const fetchedEmails = await fetchEmailsFromAPI(currentUser.role);

      // Only update if the number of emails has changed to avoid unnecessary re-renders
      if (fetchedEmails && fetchedEmails.length !== currentMessages.length) {
        console.log("New email count differs. Updating view.");

        // Preserve the read status of messages that still exist
        const readStatusMap = new Map();
        currentMessages.forEach(msg => {
          if (msg.isRead) {
            readStatusMap.set(msg.subject, true); // Using subject as a simple key
          }
        });

        const updatedMessages = fetchedEmails.map(email => ({
          ...email,
          isRead: readStatusMap.has(email.subject)
        }));

        currentMessages = updatedMessages;
        applyFilters(); // Re-renders the message cards
        setupDashboardView(); // Updates the counts in the dashboard
      }
    }

    // --- UI & Navigation ---
    function showMessageBox(title, content) {
      messageBoxTitle.textContent = title;
      messageBoxContent.textContent = content;
      messageBox.classList.remove("hidden");
      setTimeout(() => messageBox.classList.add('hidden'), 5000); // Increased timeout for better readability
    }
    closeMessageBoxBtn.addEventListener("click", () => messageBox.classList.add("hidden"));

    function showView(viewId) {
      const activeView = document.querySelector('.main-view:not(.hidden)');
      if (activeView) {
        activeView.classList.add('view-fade-out');
        setTimeout(() => {
          activeView.classList.add('hidden');
          activeView.classList.remove('view-fade-out');
          const nextView = document.getElementById(viewId);
          if (nextView) {
            nextView.classList.remove('hidden');
            setTimeout(() => nextView.classList.add('view-fade-in'), 10);
          }
        }, 300);
      } else {
        const nextView = document.getElementById(viewId);
        if (nextView) {
          nextView.classList.remove('hidden');
          setTimeout(() => nextView.classList.add('view-fade-in'), 10);
        }
      }
      sideMenuLinks.forEach(link => {
        link.classList.toggle('bg-blue-700', link.dataset.view === viewId);
      });
      if (viewId.includes('analytics') && !initializedCharts[viewId]) initAnalyticsCharts();
      if (viewId.includes('-view') && !viewId.includes('dashboard') && !viewId.includes('messages') && !initializedCharts[viewId]) initProblemSolverChart(viewId);
    }

    sideMenuLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        showView(e.currentTarget.dataset.view);
      });
    });

    // --- Login & Sign Out ---
    function populatePendingTasks() {
      pendingTasksList.innerHTML = '';
      const tasks = pendingTasks[currentUser.role] || pendingTasks.default;
      if (tasks.length === 0) {
        pendingTasksList.innerHTML = '<li class="text-gray-500">No pending tasks. Great job!</li>';
        return;
      }
      tasks.forEach(task => {
        const li = document.createElement('li');
        li.className = 'flex items-center text-gray-700 py-2 border-b border-gray-200';
        li.innerHTML = `<input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3" /><span>${task}</span>`;
        pendingTasksList.appendChild(li);
      });
    }

    const setupDashboardView = () => {
      welcomeMessage.innerHTML = `Welcome, <span class="font-bold text-gray-900">${currentUser.name}!</span>`;
      roleSubtitle.textContent = `Your personalized dashboard for the ${currentUser.role} role.`;
      metricTotalDocs.textContent = currentMessages.length;
      metricUnread.textContent = currentMessages.filter(msg => !msg.isRead).length;
      metricPending.textContent = (pendingTasks[currentUser.role] || pendingTasks.default).length;
      recentActivityList.innerHTML = '';
      const activities = recentActivities[currentUser.role] || recentActivities.default;
      activities.forEach(act => {
        const li = document.createElement('li');
        li.className = 'flex items-center text-sm text-gray-700 p-2 rounded-lg hover:bg-gray-50';
        const icons = {
          completed: '<i data-lucide="check-circle-2" class="w-5 h-5 mr-3 text-green-500"></i>',
          new: '<i data-lucide="mail" class="w-5 h-5 mr-3 text-blue-500"></i>',
          pending: '<i data-lucide="clock" class="w-5 h-5 mr-3 text-yellow-500"></i>'
        };
        li.innerHTML = `${icons[act.status]} ${act.text}`;
        recentActivityList.appendChild(li);
      });
      populatePendingTasks();
      lucide.createIcons();
    };

    async function setupAppForUser(user) {
      currentUser = user;
      currentMessages = await fetchEmailsFromAPI(currentUser.role);
      loginScreen.classList.add("hidden");
      dashboardScreen.classList.remove("hidden");
      setupDashboardView();
      populateFilters();
      displayMessages(currentMessages);
      showView('dashboard-view');
      lucide.createIcons();
      // Start the refresh interval after a successful login
      if (emailRefreshInterval) clearInterval(emailRefreshInterval); // Clear previous interval
      emailRefreshInterval = setInterval(refreshMessages, 5000); // Set new interval
    }

    const handleLogin = () => {
      const employeeName = employeeNameInput.value.trim();
      const username = usernameInput.value.trim();
      const roleType = roleTypeSelect.value;
      let specificRole = "", location = "";
      if (roleType === "Central Command") specificRole = centralCommandRoleSelect.value;
      else if (roleType === "Field Units") {
        specificRole = fieldUnitRoleSelect.value;
        location = fieldUnitLocationSelect.value;
      }
      if (!employeeName || !username || !roleType || !specificRole || (roleType === "Field Units" && !location)) {
        return showMessageBox("Login Error", "Please fill in all the required fields.");
      }
      const user = { name: employeeName, username, role: specificRole, location, roleType };
      localStorage.setItem('kmrlUser', JSON.stringify(user));
      setupAppForUser(user);
    };

    roleTypeSelect.addEventListener("change", () => {
      centralCommandRolesDiv.classList.toggle("hidden", roleTypeSelect.value !== "Central Command");
      fieldUnitsRolesDiv.classList.toggle("hidden", roleTypeSelect.value !== "Field Units");
      fieldUnitsLocationDiv.classList.add("hidden");
    });

    fieldUnitRoleSelect.addEventListener("change", () => {
      const selectedRole = fieldUnitRoleSelect.value;
      const showLocations = selectedRole === "Station Controller" || selectedRole === "Depot Manager";
      fieldUnitsLocationDiv.classList.toggle("hidden", !showLocations);
      if (showLocations) {
        const locations = selectedRole === "Station Controller" ? stationLocations : depotLocations;
        fieldUnitLocationSelect.innerHTML = "<option value=''>Select location</option>" + locations.map(loc => `<option value="${loc}">${loc}</option>`).join("");
      }
    });

    nextBtn.addEventListener("click", () => {
      const roleType = roleTypeSelect.value;
      let specificRole = "", location = "";
      if (roleType === "Central Command") specificRole = centralCommandRoleSelect.value;
      else if (roleType === "Field Units") {
        specificRole = fieldUnitRoleSelect.value;
        location = fieldUnitLocationSelect.value;
      }
      if (!roleType || !specificRole || (roleType === "Field Units" && !location)) {
        return showMessageBox("Validation Error", "Please select your role and location.");
      }
      loginStep1.classList.add("hidden");
      loginStep2.classList.remove("hidden");
    });

    proceedToLoginBtn.addEventListener("click", handleLogin);

    signOutBtn.addEventListener("click", () => {
      // Stop the refresh interval on sign out
      if (emailRefreshInterval) {
        clearInterval(emailRefreshInterval);
        emailRefreshInterval = null;
      }
      localStorage.removeItem('kmrlUser');
      currentUser = null;
      currentMessages = [];
      loginScreen.classList.remove("hidden");
      dashboardScreen.classList.add("hidden");
      loginStep1.classList.remove("hidden");
      loginStep2.classList.add("hidden");
      roleTypeSelect.value = "";
      centralCommandRoleSelect.value = "";
      fieldUnitRoleSelect.value = "";
      fieldUnitLocationSelect.value = "";
      centralCommandRolesDiv.classList.add("hidden");
      fieldUnitsRolesDiv.classList.add("hidden");
      fieldUnitsLocationDiv.classList.add("hidden");
      employeeNameInput.value = "";
      usernameInput.value = "";
      password.value = "";
      initializedCharts = {};
      Object.values(Chart.instances).forEach(chart => chart.destroy());
    });

    // --- Message Filtering & Display ---
    const populateFilters = () => {
      const tagsForRole = roleSpecificTags[currentUser.role] || roleSpecificTags.default;
      tagFilter.innerHTML = tagsForRole.map(tag => `<option value="${tag}">${tag}</option>`).join("");

      const priorities = ["All", "High", "Medium", "Low"];
      priorityFilter.innerHTML = priorities.map(p => `<option value="${p}">${p}</option>`).join("");
    };

    const applyFilters = () => {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedTag = tagFilter.value;
      const selectedPriority = priorityFilter.value;
      const filtered = currentMessages.filter(msg =>
        (msg.subject.toLowerCase().includes(searchTerm) || msg.content.toLowerCase().includes(searchTerm)) &&
        (selectedTag === "All" || msg.tag === selectedTag) &&
        (selectedPriority === "All" || msg.priority === selectedPriority)
      );
      displayMessages(filtered);
    };

    searchInput.addEventListener("input", applyFilters);
    tagFilter.addEventListener("change", applyFilters);
    priorityFilter.addEventListener("change", applyFilters);

    const displayMessages = (messagesToDisplay) => {
      messagesContainer.innerHTML = "";
      if (messagesToDisplay.length === 0) {
        messagesContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">No messages found.</p>';
        return;
      }
      messagesToDisplay.forEach(msg => {
        const card = document.createElement("div");
        card.className = `bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition-all duration-200 flex flex-col justify-between border-l-4 ${!msg.isRead ? 'border-blue-500' : 'border-transparent'}`;
        const priorityColors = { High: "bg-red-500", Medium: "bg-yellow-500", Low: "bg-green-500" };
        card.innerHTML = `<div><div class="flex items-center justify-between mb-2"><span class="text-sm font-bold text-gray-800">${msg.type}</span><div class="flex space-x-2"><span class="text-xs font-semibold uppercase text-blue-600 rounded-full px-2 py-1 bg-blue-100">${msg.tag}</span><span class="text-xs font-semibold uppercase rounded-full px-2 py-1 text-white ${priorityColors[msg.priority] || 'bg-gray-400'}">${msg.priority}</span></div></div><h3 class="text-xl font-bold text-gray-900 truncate mb-1">${msg.subject}</h3><p class="text-gray-600 text-sm truncate-3-lines leading-5">${msg.content}</p></div>`;
        card.addEventListener("click", () => showFullMessage(msg));
        messagesContainer.appendChild(card);
      });
    };

    const showFullMessage = (msg) => {
      messageToForward = msg;
      modalTitle.textContent = msg.subject;
      modalContent.textContent = msg.content;
      modalTag.textContent = msg.tag;
      const originalMessage = currentMessages.find(m => m.id === msg.id);
      if (originalMessage && !originalMessage.isRead) {
        originalMessage.isRead = true;
        applyFilters();
        setupDashboardView();
      }
      const priorityColors = { High: "bg-red-500", Medium: "bg-yellow-500", Low: "bg-green-500" };
      modalPriorityTag.textContent = msg.priority;
      modalPriorityTag.className = `text-xs font-semibold uppercase rounded-full px-2 py-1 text-white ${priorityColors[msg.priority] || 'bg-gray-400'}`;
      summaryEl.textContent = "";
      fullMessageModal.classList.remove("hidden");
    };
    closeModalBtn.addEventListener("click", () => fullMessageModal.classList.add("hidden"));

    // --- AI SUMMARIZATION ---
    async function summarizeWithAI(textToSummarize) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{
                parts: [{
                    text: `Summarize the following email text in three brief, clear bullet points, focusing on the main topic and any required actions:\n\n---\n\n${textToSummarize}`
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("AI API Error:", errorBody);
                throw new Error(`API Error: ${errorBody.error.message}`);
            }

            const result = await response.json();
            const summary = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!summary) {
                 throw new Error("Could not extract summary from AI response.");
            }
            return summary;

        } catch (error) {
            console.error("Summarization failed:", error);
            return `Error: Could not generate summary. ${error.message}`;
        }
    }


    // --- Forward & Summarize Logic ---
    forwardMessageBtn.addEventListener('click', () => {
      const allRoles = ['Station Controller', 'Depot Manager', 'Managing Director', 'Director of Finance', 'Director of Operations'];
      const otherRoles = allRoles.filter(role => role !== currentUser.role);
      forwardRoleSelect.innerHTML = otherRoles.map(role => `<option value="${role}">${role}</option>`).join('');
      forwardMessageModal.classList.remove('hidden');
    });

    closeForwardModalBtn.addEventListener('click', () => forwardMessageModal.classList.add('hidden'));
    sendForwardBtn.addEventListener('click', () => {
      if (forwardRoleSelect.value && messageToForward) {
        showMessageBox('Success', `Message forwarded to ${forwardRoleSelect.value}.`);
        forwardMessageModal.classList.add('hidden');
        fullMessageModal.classList.add('hidden');
      } else {
        showMessageBox('Error', 'Could not forward message.');
      }
    });

    summarizeEmailBtn.addEventListener("click", async () => {
      const emailContent = modalContent.textContent;
      if (!emailContent) return;
      summaryEl.textContent = "Generating summary with AI...";
      
      const summary = await summarizeWithAI(emailContent);
      summaryEl.textContent = summary;
    });


    // --- Analytics & Problem Solver Charts ---
    const chartConfig = {
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 1000, easing: 'easeInOutQuart' },
        plugins: { legend: { position: 'top' } },
      }
    };

    function initAnalyticsCharts() {
      if (initializedCharts['analytics-view']) return;
      const priorityCounts = currentMessages.reduce((acc, msg) => { acc[msg.priority] = (acc[msg.priority] || 0) + 1; return acc; }, {});
      const typeCounts = currentMessages.reduce((acc, msg) => { acc[msg.type] = (acc[msg.type] || 0) + 1; return acc; }, {});
      const readUnread = currentMessages.reduce((acc, msg) => {
        if (!acc[msg.priority]) acc[msg.priority] = { read: 0, unread: 0 };
        msg.isRead ? acc[msg.priority].read++ : acc[msg.priority].unread++;
        return acc;
      }, {});
      new Chart('activity-chart', { type: 'line', data: { labels: ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'], datasets: [{ label: 'Messages Received', data: [15, 17, 22, 19, 25, 18], borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] }, options: chartConfig.options });
      new Chart('priority-chart', { type: 'bar', data: { labels: ['High', 'Medium', 'Low'], datasets: [{ label: '# of Messages', data: [priorityCounts.High || 0, priorityCounts.Medium || 0, priorityCounts.Low || 0], backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'] }] }, options: { ...chartConfig.options, plugins: { legend: { display: false } } } });
      new Chart('type-chart', { type: 'pie', data: { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b'] }] }, options: chartConfig.options });
      new Chart('read-unread-chart', { type: 'bar', data: { labels: ['High', 'Medium', 'Low'], datasets: [{ label: 'Read', data: ['High', 'Medium', 'Low'].map(p => readUnread[p]?.read || 0), backgroundColor: '#22c55e' }, { label: 'Unread', data: ['High', 'Medium', 'Low'].map(p => readUnread[p]?.unread || 0), backgroundColor: '#f59e0b' }] }, options: { ...chartConfig.options, scales: { x: { stacked: true }, y: { stacked: true } } } });
      new Chart('workload-chart', { type: 'radar', data: { labels: ['Finance', 'Ops', 'Safety', 'HR', 'Projects'], datasets: [{ label: 'Messages', data: [8, 12, 9, 6, 7], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6' }] }, options: chartConfig.options });
      initializedCharts['analytics-view'] = true;
    }

    function initProblemSolverChart(viewId) {
      if (initializedCharts[viewId]) return;
      const charts = {
        'passenger-flow-view': () => {
          new Chart('passenger-flow-chart', { type: 'bar', data: { labels: ['6-9am', '9-12pm', '12-3pm', '3-6pm', '6-9pm'], datasets: [{ label: 'Avg Passengers', data: [8500, 6200, 5100, 9200, 7100], backgroundColor: '#3b82f6' }] }, options: chartConfig.options });
          new Chart('station-traffic-chart', { type: 'bar', data: { labels: ['Aluva', 'Kalamassery', 'Maharajas', 'Vyttila'], datasets: [{ label: 'Entries', data: [4500, 3200, 5100, 4800], backgroundColor: '#22c55e' }, { label: 'Exits', data: [4200, 3500, 4900, 5000], backgroundColor: '#8b5cf6' }] }, options: chartConfig.options });
        },
        'maintenance-view': () => {
          new Chart('maintenance-chart', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Health Score', data: [98, 97, 95, 88, 82, 79], borderColor: '#ef4444', tension: 0.4, fill: true, backgroundColor: 'rgba(239, 68, 68, 0.1)' }, { label: 'Threshold', data: [80, 80, 80, 80, 80, 80], borderColor: '#f59e0b', borderDash: [5, 5] }] }, options: chartConfig.options });
          new Chart('component-failure-chart', { type: 'doughnut', data: { labels: ['Brake Pads', 'HVAC Unit', 'Door Sensors', 'Pantograph'], datasets: [{ data: [35, 25, 20, 20], backgroundColor: ['#ef4444', '#f59e0b', '#8b5cf6', '#3b82f6'] }] }, options: chartConfig.options });
        },
        'energy-view': () => {
          new Chart('energy-chart', { type: 'line', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Usage (MWh)', data: [110, 115, 112, 120, 118, 95, 90], borderColor: '#22c55e' }, { label: 'Target', data: [112, 112, 112, 112, 112, 98, 92], borderColor: '#a8a29e', borderDash: [5, 5] }] }, options: chartConfig.options });
          new Chart('energy-breakdown-chart', { type: 'pie', data: { labels: ['Traction', 'Stations', 'Depots', 'Auxiliary'], datasets: [{ data: [65, 20, 10, 5], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#64748b'] }] }, options: chartConfig.options });
        },
        'revenue-view': () => {
          new Chart('revenue-chart', { type: 'doughnut', data: { labels: ['Advertising', 'Retail Leases', 'Parking Fees', 'Telecom Towers'], datasets: [{ data: [45, 30, 15, 10], backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'] }] }, options: chartConfig.options });
          new Chart('revenue-growth-chart', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'], datasets: [{ label: 'Advertising', data: [120, 125, 135, 140, 155], borderColor: '#3b82f6' }, { label: 'Retail', data: [80, 82, 85, 84, 90], borderColor: '#8b5cf6' }] }, options: chartConfig.options });
        },
        'incident-view': () => {
          new Chart('incident-chart', { type: 'bar', data: { labels: ['Signal Failure', 'Track Obstruction', 'Medical', 'Security'], datasets: [{ label: 'Avg Mins', data: [22, 15, 8, 12], backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6'] }] }, options: { ...chartConfig.options, indexAxis: 'y', plugins: { legend: { display: false } } } });
          new Chart('incident-time-chart', { type: 'bar', data: { labels: ['Morning Peak', 'Mid-Day', 'Evening Peak', 'Night'], datasets: [{ label: 'Incidents', data: [8, 5, 12, 3], backgroundColor: '#ef4444' }] }, options: { ...chartConfig.options, plugins: { legend: { display: false } } } });
        }
      };
      if (charts[viewId]) charts[viewId]();
      initializedCharts[viewId] = true;
    }

    window.onload = () => {
      const savedUser = localStorage.getItem('kmrlUser');
      if (savedUser) {
        setupAppForUser(JSON.parse(savedUser));
      } else {
        loginScreen.classList.remove("hidden");
        dashboardScreen.classList.add("hidden");
      }
      lucide.createIcons();
    };
  </script>
</body>

</html>

